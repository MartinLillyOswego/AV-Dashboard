import pygame
import time
import os

class ControllerTester():

    def __init__(self):
        # Variables
        self.connected = False
        self.controller = None
        self.controllerName = ""
        self.throttle = 0
        self.brake = 0
        self.steering = 128
        self.handbrake = 0
        self.gear = 1
        self.controllerCount = 0
    def clearWindow(self):
        os.system("cls")
        print("\033[H\033[J", end="")

    def controllerConnect(self):
        #Initialize pygame and joystick
        pygame.init()
        pygame.joystick.init()

        #clear terminal window
        self.clearWindow()

        #Get number of controllers
        self.controllerCount = pygame.joystick.get_count()
        if self.controllerCount > 0:
            self.controller = pygame.joystick.Joystick(0)
            self.controllerName = self.controller.get_name()
            self.connected = True
            print(f"{self.controllerName}")
        else:
             print(f"No Controller Connected")
             self.connected = False
             self.controllerName = None
             self.controller = None
        time.sleep(2)

    def game(self):
        running = True
        while running:
            if self.connected:
                for event in pygame.event.get():
                    if event.type == pygame.QUIT:
                        running = False
                    running = not self.controller.get_button(7)
                    if event.type == pygame.JOYBUTTONDOWN:
                        if self.controller.get_button(0) == 1:
                            if self.handbrake == 0:
                                self.handbrake = 255
                            else:
                                self.handbrake = 0

                        if self.gear == 1 and self.throttle >= 10:
                            self.gear = min(5, self.gear + self.controller.get_button(5))
                        elif self.gear == 1 and self.throttle < 10:
                            self.gear = min(5, self.gear + self.controller.get_button(5))
                            self.gear = max(0, self.gear - self.controller.get_button(4))
                            if self.controller.get_button(1) == 1:
                                self.gear = 0
                        else:
                            self.gear = min(5, self.gear + self.controller.get_button(5))
                            self.gear = max(0, self.gear - self.controller.get_button(4))

                    if event.type == pygame.JOYAXISMOTION:
                        self.throttle = int(((self.controller.get_axis(5)+1)*255)/2)
                        self.brake    = int(((self.controller.get_axis(4)+1)*255)/2)
                        self.steering = int(((self.controller.get_axis(0)+1)*255)/2)

                # Print screen
                os.system("cls")
                print("\033[H\033[J", end="")
                print(f"Throttle   : {self.throttle}")
                print(f"Brake      : {self.brake}")
                print(f"Steer Angle: {self.steering}")
                print(f"Hand Brake : {self.handbrake}")
                print(f"Gear       : {self.gear}")
                print(f"Controller :{self.controllerName}")
                time.sleep(.1)

                # check if connected
                if pygame.joystick.get_count() < self.controllerCount:
                    self.controllerConnect()

            else:
                self.controllerConnect()
        print("EXITING...")

controls = ControllerTester()
pygame.init()
controls.game()
